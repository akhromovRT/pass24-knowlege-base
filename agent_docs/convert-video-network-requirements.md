# Требования к интернет-соединениям для команды ConvertVideoMD

Документ описывает все внешние интернет-соединения, которые требуются для выполнения команды `/convert-video-md`.

## Общая информация

Команда `convert-video-md` использует библиотеку `openai-whisper` для распознавания речи из видео. Эта библиотека требует загрузки моделей машинного обучения и словарей токенизации из внешних источников.

**Важно:** После первой успешной загрузки модели и словарей они кэшируются локально, и последующие запуски команды **не требуют интернет-соединения** (если модель уже загружена).

---

## Список интернет-соединений

### 1. Загрузка моделей Whisper

**Назначение:** Загрузка предобученных моделей машинного обучения для распознавания речи.

**URL-адреса:**
- `https://openaipublic.azureedge.net/whisper/models/`
- Конкретные файлы моделей:
  - `tiny.pt` (~39 MB) — для модели `tiny`
  - `base.pt` (~142 MB) — для модели `base` (по умолчанию)
  - `small.pt` (~461 MB) — для модели `small`
  - `medium.pt` (~1.4 GB) — для модели `medium`
  - `large-v2.pt` или `large-v3.pt` (~2.9 GB) — для модели `large`

**Полные URL примеры:**
- `https://openaipublic.azureedge.net/whisper/models/base.pt`
- `https://openaipublic.azureedge.net/whisper/models/small.pt`
- `https://openaipublic.azureedge.net/whisper/models/large-v3.pt`

**Когда происходит:**
- При первом запуске команды с конкретной моделью
- Если модель была удалена из кэша (`~/.cache/whisper/` или `$XDG_CACHE_HOME/whisper`)
- При смене модели (например, с `base` на `small`)

**Протокол:** HTTPS

**Порт:** 443

**Хост:** `openaipublic.azureedge.net` (Azure CDN)

**Размер данных:**
- Зависит от выбранной модели (см. размеры выше)
- Модель `base` (по умолчанию): ~142 MB

**Поведение при ошибках:**
- Скрипт автоматически повторяет попытки до 5 раз с увеличивающимися задержками (5, 15, 30, 60, 120 секунд)
- Таймаут сокетов увеличен до 600 секунд для загрузки больших файлов

---

### 2. Загрузка словаря токенизации (tiktoken)

**Назначение:** Загрузка словаря для токенизации текста при первом вызове `model.transcribe()`.

**URL-адреса:**
- `https://openaipublic.blob.core.windows.net/`
- Конкретные файлы словарей (загружаются автоматически библиотекой `tiktoken`)

**Когда происходит:**
- При первом вызове `model.transcribe()` в сессии
- Если словарь не был закэширован локально

**Протокол:** HTTPS

**Порт:** 443

**Хост:** `openaipublic.blob.core.windows.net` (Azure Blob Storage)

**Размер данных:**
- Небольшой (несколько мегабайт)
- Зависит от используемого токенизатора

**Поведение при ошибках:**
- Скрипт автоматически повторяет попытки до 5 раз с увеличивающимися задержками
- Ошибки обрабатываются той же логикой retry, что и загрузка моделей

---

## Локальное кэширование

### Расположение кэша

После успешной загрузки модели и словарей они сохраняются локально:

**Модели Whisper:**
- **macOS/Linux:** `~/.cache/whisper/` или `$XDG_CACHE_HOME/whisper/`
- **Windows:** `C:\Users\<username>\.cache\whisper\`

**Словари tiktoken:**
- Кэшируются библиотекой `tiktoken` в системной директории кэша Python

### Поведение при наличии кэша

Если модель уже загружена и находится в кэше:
- ✅ **Интернет-соединение НЕ требуется**
- ✅ Команда работает полностью офлайн
- ✅ Обработка видео происходит локально

---

## Требования к сети

### Минимальные требования

- **Стабильное интернет-соединение** (только при первой загрузке модели)
- **Пропускная способность:** рекомендуется не менее 1 Мбит/с для комфортной загрузки
- **Доступ к Azure CDN:** `openaipublic.azureedge.net` и `openaipublic.blob.core.windows.net`
- **HTTPS доступ:** порт 443 должен быть открыт

### Рекомендации

1. **Первая загрузка модели:**
   - Запустите команду с коротким тестовым видео при стабильном интернете
   - Модель сохранится в кэш, и последующие запуски не потребуют интернета

2. **При нестабильном интернете:**
   - Скрипт автоматически повторяет попытки при сетевых ошибках
   - Увеличенный таймаут (600 секунд) помогает при медленных соединениях

3. **Корпоративные сети:**
   - Убедитесь, что Azure CDN не блокируется корпоративным фаерволом
   - При необходимости настройте прокси для HTTPS-соединений

---

## Проверка доступности

### Проверка доступности Azure CDN

```bash
# Проверка доступности CDN для моделей
curl -I https://openaipublic.azureedge.net/whisper/models/base.pt

# Проверка доступности Blob Storage для словарей
curl -I https://openaipublic.blob.core.windows.net/
```

### Проверка наличия модели в кэше

```bash
# macOS/Linux
ls -lh ~/.cache/whisper/

# Windows
dir %USERPROFILE%\.cache\whisper\
```

---

## Альтернативные решения

### Офлайн-работа

Если интернет недоступен, но модель уже загружена:
- ✅ Команда работает полностью офлайн
- ✅ Все операции выполняются локально

### Предварительная загрузка моделей

Для предварительной загрузки всех моделей можно запустить:

```python
import whisper

# Загрузить все модели (они сохранятся в кэш)
for model_name in ['tiny', 'base', 'small', 'medium', 'large']:
    print(f"Загрузка модели {model_name}...")
    whisper.load_model(model_name)
    print(f"Модель {model_name} загружена и закэширована")
```

---

## Сводная таблица соединений

| № | Назначение | Хост | Протокол | Порт | Размер данных | Когда требуется |
|---|------------|------|----------|------|---------------|-----------------|
| 1 | Загрузка моделей Whisper | `openaipublic.azureedge.net` | HTTPS | 443 | 39 MB - 2.9 GB | При первом использовании модели |
| 2 | Загрузка словарей tiktoken | `openaipublic.blob.core.windows.net` | HTTPS | 443 | Несколько MB | При первом `transcribe()` |

---

## Примечания

1. **Без интернета:** После первой загрузки модели команда работает полностью офлайн
2. **Повторные попытки:** Скрипт автоматически повторяет попытки при сетевых ошибках (до 5 раз)
3. **Таймауты:** Увеличенные таймауты (600 секунд) помогают при медленных соединениях
4. **Кэширование:** Все загруженные данные сохраняются локально и не требуют повторной загрузки
5. **Безопасность:** Все соединения используют HTTPS (шифрование)

---

## Связанные документы

- [Команда convert-video-md](.cursor/commands/convert-video-md.md) — полная документация команды
- [Скрипт convert_video_to_md.py](scripts/convert_video_to_md.py) — исходный код скрипта

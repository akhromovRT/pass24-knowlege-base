# Инструкция по использованию скрипта парсинга

## Описание

Скрипт `parse_cottage_villages.py` предназначен для автоматического сбора информации о коттеджных поселках РФ из различных источников в интернете.

## Требования

### Установка зависимостей

```bash
pip install requests beautifulsoup4 lxml
```

Для использования Selenium (рекомендуется для получения телефонов):

```bash
pip install selenium webdriver-manager
```

Или используйте файл requirements.txt:

```bash
pip install -r requirements.txt
```

### Создание файла requirements.txt

Файл `requirements.txt` уже создан и содержит:

```
requests>=2.31.0
beautifulsoup4>=4.12.0
lxml>=4.9.0
selenium>=4.15.0
webdriver-manager>=4.0.0
```

## Использование

### Базовое использование

```bash
python parse_cottage_villages.py
```

### Настройка параметров

Откройте файл `parse_cottage_villages.py` и измените параметры в функции `main()`:

```python
def main():
    parser = VillageParser()
    
    # Источники для парсинга
    sources = ['cian', 'domclick', 'yandex', 'cottage', 'poselki', 'avito']
    
    # Регионы для парсинга
    regions = ['moskovskaya-oblast', 'leningradskaya-oblast']
    
    # Количество страниц для парсинга
    max_pages = 5
    
    parser.run(sources=sources, regions=regions, max_pages=max_pages)
```

## Источники данных

### Основной скрипт (parse_cottage_villages.py)

Скрипт поддерживает парсинг из следующих источников:

1. **Cian.ru** - крупнейший портал недвижимости
2. **DomClick.ru** - портал Сбербанка
3. **Яндекс.Недвижимость** - агрегатор объявлений
4. **Cottage.ru** - специализированный портал
5. **Poselki.ru** - каталог коттеджных поселков (базовая версия)
6. **Авито Недвижимость** - раздел коттеджных поселков

### Специализированный скрипт для Poselki.ru (parse_poselki_ru.py)

Отдельный скрипт `parse_poselki_ru.py` предназначен для детального парсинга информации с сайта **Poselki.ru**. 

**Особенности:**
- Парсит главную страницу Poselki.ru
- Находит ссылки на сайты отдельных поселков
- Парсит информацию с сайтов поселков (верба-парк.рф, марьина-гора.рф, zolotye-sosny.ru и др.)
- Извлекает контактную информацию, характеристики поселков
- Использует Selenium для получения телефонов с защищенных страниц

**Использование:**

```bash
# Базовое использование
python parse_poselki_ru.py

# Без Selenium (быстрее, но меньше данных)
python parse_poselki_ru.py --no-selenium

# Указать выходной файл
python parse_poselki_ru.py --output "Результат парсинга информации в интернете.csv"
```

**Логирование:**
Все действия скрипта логируются в файл `parsing_poselki_ru.log` и выводятся в консоль.

### Специализированный скрипт для Cottage.ru (parse_cottage_ru.py)

Отдельный скрипт `parse_cottage_ru.py` предназначен для парсинга каталога коттеджных поселков с сайта **Cottage.ru** по адресу **https://www.cottage.ru/objects/village/**.

**Особенности:**
- Парсит список поселков со страниц каталога `/objects/village/`
- Поддержка пагинации (`?page=2`, `?page=3` и т.д.)
- Извлекает название, ссылку на карточку, город/район, телефон (если не замаскирован)
- Регион по умолчанию: Московская область
- Опционально: Selenium для получения телефонов со страниц поселков
- При 429 (Too Many Requests): пауза и повтор; задержки 3–7 с между запросами

**Использование:**

```bash
# Базовое (URL и макс. страниц по умолчанию)
python parse_cottage_ru.py

# Указать URL и число страниц
python parse_cottage_ru.py --url "https://www.cottage.ru/objects/village/" --max-pages 5

# Без Selenium (быстрее)
python parse_cottage_ru.py --no-selenium --max-pages 2

# Свой выходной файл
python parse_cottage_ru.py --output "Результат парсинга информации в интернете.csv"
```

**Параметры:** `--url`, `--max-pages`, `--no-selenium`, `--selenium-headless`, `--output`.

**Логирование:**
Все действия скрипта логируются в файл `parsing_cottage_ru.log` и выводятся в консоль.

## Результаты

### Формат вывода

Результаты сохраняются в файл **"Результат парсинга информации в интернете.csv"** в формате CSV с кодировкой UTF-8-BOM (для корректного отображения в Excel).

### Структура данных

Файл содержит 43 поля согласно структуре таблицы из инструкции:

- **Блок 1:** Основная информация о поселке (7 полей)
- **Блок 2:** Характеристики поселка (8 полей)
- **Блок 3:** Контактная информация (8 полей)
- **Блок 4:** Квалификация по CHAMP (5 полей)
- **Блок 5:** Статус работы (7 полей)
- **Блок 6:** Результаты работы (4 поля)
- **Блок 7:** Дополнительная информация (4 поля)

### Логирование

Все действия скрипта логируются в файл `parsing.log` и выводятся в консоль.

## Особенности работы

### Задержки между запросами

Скрипт использует случайные задержки между запросами (2-5 секунд) для:
- Соблюдения правил использования сайтов
- Избежания блокировок
- Имитации человеческого поведения

### Обработка ошибок

Скрипт обрабатывает следующие ситуации:
- Ошибки сети (таймауты, недоступность сайтов)
- Изменение структуры страниц
- Отсутствие данных
- Дубликаты записей

### Удаление дубликатов

Скрипт автоматически удаляет дубликаты по названию поселка и адресу, объединяя данные из разных источников.

### Обогащение данных

Для первых 10 поселков скрипт дополнительно загружает детальные страницы для получения более полной информации.

## Ограничения

### Технические ограничения

1. **Антибот защита:** Некоторые сайты могут блокировать автоматические запросы
2. **Динамический контент:** Сайты с JavaScript могут требовать использования Selenium/Playwright
3. **Изменение структуры:** Структура страниц может изменяться, что требует обновления парсера

### Рекомендации

1. **Использовать прокси:** При большом объеме парсинга рекомендуется использовать прокси-серверы
2. **Увеличить задержки:** При блокировках увеличить задержки между запросами
3. **Использовать Selenium:** Для сайтов с динамическим контентом использовать Selenium или Playwright
4. **Ручная проверка:** Всегда проверять результаты парсинга вручную

## Расширение функциональности

### Добавление нового источника

1. Создайте метод `parse_new_source()` в классе `VillageParser`
2. Добавьте логику парсинга страниц
3. Добавьте источник в список `sources` в функции `main()`

### Улучшение парсинга

1. Добавьте специфичные селекторы для каждого источника
2. Улучшите извлечение данных (телефоны, email, адреса)
3. Добавьте валидацию данных

## Примеры использования

### Парсинг только Cian.ru для Московской области

```python
parser = VillageParser()
parser.run(sources=['cian'], regions=['moskovskaya-oblast'], max_pages=3)
```

### Парсинг всех источников для нескольких регионов

```python
parser = VillageParser()
parser.run(
    sources=['cian', 'domclick', 'yandex'],
    regions=['moskovskaya-oblast', 'leningradskaya-oblast'],
    max_pages=5
)
```

## Поддержка

При возникновении проблем:

1. Проверьте логи в файле `parsing.log`
2. Убедитесь, что все зависимости установлены
3. Проверьте доступность интернет-соединения
4. Обратитесь к разработчику скрипта

## Важные замечания

⚠️ **Внимание:** 
- Парсинг может нарушать правила использования некоторых сайтов
- Рекомендуется использовать официальные API, если они доступны
- При коммерческом использовании убедитесь в соблюдении законодательства
- Регулярно проверяйте актуальность данных

## Лицензия

Скрипт создан для внутреннего использования компании PASS24.online.

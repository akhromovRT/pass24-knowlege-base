# Техническая инструкция: PASS24 AI Консьерж

## Назначение документа

Данный документ предназначен для технических специалистов компании и содержит подробное описание внутренней работы бота PASS24 AI Консьерж: архитектура, методы, источники данных и процесс формирования ответов.

---

## 1. Обзор архитектуры

### 1.1 Основные компоненты

Бот состоит из следующих ключевых модулей:

- **`bot/telegram_bot.py`** — основной класс Telegram-бота, обработка сообщений и команд
- **`bot/concierge.py`** — ядро консьержа, интерфейс к Claude API
- **`bot/prompts.py`** — система промптов для разных типов консультаций
- **`bot/pass24_info.py`** — справочник функций PASS24 и работа с базой знаний
- **`bot/knowledge_base.py`** — загрузчик базы знаний из GitHub репозитория
- **`bot/audit.py`** — модуль AI-аудита безопасности

### 1.2 Технологический стек

- **Python 3.8+** — основной язык программирования
- **Claude API (Anthropic)** — генерация ответов через LLM
  - Модель по умолчанию: `claude-3-haiku-20240307`
  - Настраивается через переменную окружения `CLAUDE_MODEL`
- **python-telegram-bot (>=20.0)** — библиотека для работы с Telegram Bot API
- **openai-whisper** — распознавание речи из голосовых сообщений
  - Модель по умолчанию: `tiny` (настраивается через `WHISPER_MODEL`)
- **GitHub API** — загрузка базы знаний из репозитория `akhromovRT/pass24-knowlege-base`

---

## 2. Ключевые классы и методы

### 2.1 `TelegramBot` (`bot/telegram_bot.py`)

Основной класс для работы с Telegram.

#### Инициализация

```python
def __init__(self):
    # Инициализация консьержа
    self.concierge = Pass24Concierge()
    
    # Загрузка модели Whisper для распознавания речи
    self.whisper_model = whisper.load_model(whisper_model_name)
    
    # Хранилище активных аудитов по пользователям
    self.active_audits = {}
    
    # История сообщений пользователей (последние 10)
    self.user_message_history = {}
```

#### Основные методы

**`handle_text(update, context)`**
- Обрабатывает текстовые сообщения от пользователей
- Сохраняет сообщение в историю
- Вызывает `_process_query()` для обработки запроса

**`handle_voice(update, context)`**
- Обрабатывает голосовые сообщения
- Использует Whisper для распознавания речи
- После распознавания обрабатывает как текстовое сообщение

**`_process_query(update, context, text)`** — **ключевой метод маршрутизации**
- Определяет тип запроса по ключевым словам
- Маршрутизирует запрос к соответствующему обработчику:
  - Функции PASS24 → `Pass24Functions.get_function_info()`
  - Консультации по безопасности → `ConsultationPrompts.security_consultation()`
  - Консультации по продажам → `Pass24Functions.get_sales_info()` + `ConsultationPrompts.sales_consultation()`
  - Консультации по техподдержке → `Pass24Functions.get_support_info()` + `ConsultationPrompts.support_consultation()`
  - Общие консультации → прямой вызов `concierge.consult()`

**`_cannot_answer_question(response, user_question)`**
- Анализирует ответ от Claude на наличие индикаторов невозможности ответить
- Возвращает `True`, если нужно переадресовать в поддержку

**`_forward_to_support(update, context, text)`**
- Пересылает сообщение в указанный чат поддержки (если настроен `SUPPORT_CHAT_ID`)

### 2.2 `Pass24Concierge` (`bot/concierge.py`)

Ядро консьержа — интерфейс к Claude API.

#### Системный промпт

Бот использует фиксированный системный промпт, который определяет:
- Роль: PASS24 AI Консьерж, вежливый консультативный помощник
- Что делает: помогает по дому, консультирует по безопасности, проводит аудит, объясняет функции PASS24
- Чего не делает: не выполняет действий, не управляет системами, не даёт инструкций "нажмите/сделайте"
- Стиль: кратко (3–5 предложений), спокойно, уважительно, без давления

#### Метод `consult(user_message, context=None)`

```python
def consult(self, user_message: str, context: Optional[Dict[str, Any]] = None) -> str:
    messages = [{"role": "user", "content": user_message}]
    
    response = self.client.messages.create(
        model=self.model,
        max_tokens=1024,
        system=self.system_prompt,
        messages=messages,
    )
    
    return response.content[0].text
```

**Параметры:**
- `user_message` — сообщение пользователя или промпт
- `context` — дополнительный контекст (не используется напрямую, но может быть расширен)

**Возвращает:** текст ответа от Claude API

### 2.3 `ConsultationPrompts` (`bot/prompts.py`)

Статический класс с методами для формирования промптов.

#### Методы промптов

**`home_advice(topic, season=None)`**
- Формирует промпт для консультаций по дому и участку
- Учитывает сезонность, если указана

**`security_consultation(question)`**
- Формирует промпт для консультаций по безопасности
- Подчёркивает, что это консультация, не инструкция

**`pass24_function_explanation(function_name)`**
- Формирует промпт для объяснения функций PASS24
- Акцент на логику и смысл функции, не на пошаговые инструкции

**`sales_consultation(question, context=None)`**
- Формирует промпт для консультаций по продажам
- Включает контекст из базы знаний, если передан

**`support_consultation(question, context=None)`**
- Формирует промпт для консультаций по техподдержке
- Включает контекст из базы знаний, если передан

### 2.4 `Pass24Functions` (`bot/pass24_info.py`)

Справочник функций PASS24 и работа с базой знаний.

#### Статический словарь функций

Класс содержит встроенный словарь `FUNCTIONS` с описаниями функций:
- Управление доступом
- Видеонаблюдение
- Домофон
- Сигнализация
- Уведомления
- Гости
- PASS24.Key
- Пропуска
- Приглашения
- Запросы
- Авторизация

#### Методы

**`get_function_info(function_name)`**
- Ищет функцию по названию (регистронезависимо)
- Поддерживает синонимы и частичные совпадения
- Возвращает описание функции или `None`

**`get_sales_info(query)`**
- Ищет информацию о продажах в базе знаний
- Использует `get_sales_data()` из `knowledge_base.py`
- Поиск по ключевым словам в названиях файлов и содержимом
- Возвращает релевантный контент или `None`

**`get_support_info(query)`**
- Ищет информацию техподдержки в базе знаний
- Использует `get_support_data()` из `knowledge_base.py`
- Поиск по ключевым словам в названиях файлов и содержимом
- Возвращает релевантный контент или `None`

### 2.5 `KnowledgeBaseLoader` (`bot/knowledge_base.py`)

Загрузчик базы знаний из GitHub репозитория.

#### Конфигурация

- Репозиторий: `akhromovRT/pass24-knowlege-base`
- Ветка: `main`
- Разделы:
  - `База знаний/ОП` — данные о продажах
  - `База знаний/Тех. поддержка` — данные техподдержки

#### Методы

**`load_sales_data()`**
- Загружает все markdown файлы из раздела "База знаний/ОП"
- Рекурсивно обрабатывает поддиректории
- Возвращает словарь `{имя_файла: содержимое}`

**`load_support_data()`**
- Загружает все markdown файлы из раздела "База знаний/Тех. поддержка"
- Рекурсивно обрабатывает поддиректории
- Возвращает словарь `{имя_файла: содержимое}`

**`update_knowledge_base()`**
- Обновляет базу знаний из GitHub
- Сравнивает с кэшем, определяет новые файлы
- Сохраняет данные в JSON файлы:
  - `data/knowledge_base/sales_data.json`
  - `data/knowledge_base/support_data.json`
- Сохраняет лог обновления в `data/knowledge_base/update_log.json`

**`load_cached_data(file_path)`**
- Загружает кэшированные данные из локального JSON файла
- Используется для быстрого доступа без запросов к GitHub API

#### Вспомогательные функции

**`get_sales_data()`**
- Возвращает данные о продажах из кэша или загружает из GitHub

**`get_support_data()`**
- Возвращает данные техподдержки из кэша или загружает из GitHub

### 2.6 `SecurityAudit` (`bot/audit.py`)

Модуль для проведения AI-аудита безопасности.

#### Методы

**`start_audit(audit_type)`**
- Инициализирует аудит для указанного типа объекта ("посёлок", "дом", "квартира")
- Генерирует вопросы через `_generate_questions()`
- Возвращает первый вопрос

**`submit_answer(answer)`**
- Сохраняет ответ пользователя
- Переходит к следующему вопросу
- Если вопросы закончились, вызывает `_generate_results()`
- Возвращает словарь с статусом и следующим вопросом/результатами

**`_generate_results()`**
- Формирует контекст из всех ответов пользователя
- Создаёт промпт для Claude API с просьбой проанализировать ответы
- Генерирует оценку безопасности и рекомендации
- Возвращает результаты с уровнем безопасности (базовый/умеренный/зона повышенного внимания)

---

## 3. Источники данных

### 3.1 Claude API (Anthropic)

**Назначение:** Генерация ответов на основе системного промпта и контекста пользователя.

**Модель:** `claude-3-haiku-20240307` (настраивается через `CLAUDE_MODEL`)

**Использование:**
- Все ответы бота генерируются через Claude API
- Системный промпт определяет стиль и поведение бота
- Пользовательские промпты формируются через `ConsultationPrompts`

### 3.2 Системный промпт

**Расположение:** `bot/concierge.py`, атрибут `self.system_prompt`

**Содержание:**
- Роль и назначение бота
- Что бот делает и чего не делает
- Правила стиля общения
- Ограничения (не даёт инструкций, не выполняет действий)

**Использование:** Передаётся в каждый запрос к Claude API как параметр `system`

### 3.3 База знаний из GitHub

**Репозиторий:** `akhromovRT/pass24-knowlege-base`  
**Ветка:** `main`

**Разделы:**
1. **`База знаний/ОП`** — данные о продажах, продуктах, тарифах
2. **`База знаний/Тех. поддержка`** — инструкции, FAQ, модули продукта

**Формат данных:**
- Исходные файлы: Markdown (`.md`)
- Локальное хранилище: JSON файлы в `data/knowledge_base/`
  - `sales_data.json` — кэш данных о продажах
  - `support_data.json` — кэш данных техподдержки
  - `update_log.json` — история обновлений (последние 100 записей)

**Обновление:**
- Автоматическое обновление каждый день в 8:00 через планировщик (`scripts/scheduler.py`)
- Скрипт обновления: `scripts/update_knowledge_base.py`
- При обновлении сравниваются новые файлы с кэшем, определяются новые файлы

**Доступ:**
- Через методы `get_sales_data()` и `get_support_data()` из `knowledge_base.py`
- Используется в `Pass24Functions.get_sales_info()` и `Pass24Functions.get_support_info()`

### 3.4 Встроенный справочник функций PASS24

**Расположение:** `bot/pass24_info.py`, словарь `Pass24Functions.FUNCTIONS`

**Содержание:** Статические описания функций приложения PASS24:
- Управление доступом
- Видеонаблюдение
- Домофон
- Сигнализация
- Уведомления
- Гости
- PASS24.Key
- Пропуска
- Приглашения
- Запросы
- Авторизация

**Использование:** Через метод `Pass24Functions.get_function_info(function_name)`

**Особенности:**
- Поддержка синонимов и частичных совпадений
- Регистронезависимый поиск

### 3.5 Система промптов

**Расположение:** `bot/prompts.py`, класс `ConsultationPrompts`

**Назначение:** Формирование структурированных промптов для разных типов консультаций.

**Типы промптов:**
- Консультации по дому и участку
- Консультации по безопасности
- Объяснение функций PASS24
- Консультации по продажам (с контекстом из базы знаний)
- Консультации по техподдержке (с контекстом из базы знаний)

---

## 4. Процесс формирования ответов

### 4.1 Общий поток обработки запроса

```
1. Пользователь отправляет сообщение (текст или голос)
   ↓
2. TelegramBot.handle_text() / handle_voice()
   ↓
3. Если голос → распознавание через Whisper → текст
   ↓
4. Сохранение сообщения в историю пользователя
   ↓
5. TelegramBot._process_query() — определение типа запроса
   ↓
6. Маршрутизация к соответствующему обработчику
   ↓
7. Формирование промпта через ConsultationPrompts
   ↓
8. Поиск релевантной информации (если нужно):
   - Pass24Functions.get_function_info() — для функций PASS24
   - Pass24Functions.get_sales_info() — для продаж
   - Pass24Functions.get_support_info() — для техподдержки
   ↓
9. Добавление контекста из базы знаний в промпт (если найдено)
   ↓
10. Pass24Concierge.consult(prompt) — запрос к Claude API
   ↓
11. Получение ответа от Claude
   ↓
12. Проверка _cannot_answer_question() — может ли бот ответить?
   ↓
13. Если да → отправка ответа пользователю
    Если нет → переадресация в поддержку
```

### 4.2 Определение типа запроса

Метод `_process_query()` анализирует текст запроса по ключевым словам:

**Функции PASS24:**
- Ключевые слова: `["функция", "функции", "возможность", "возможности"]`
- Действие: Поиск функции в `Pass24Functions.list_functions()`
- Промпт: `ConsultationPrompts.pass24_function_explanation()`

**Консультации по безопасности:**
- Ключевые слова: `["безопасность", "безопасно", "охрана", "защита"]`
- Промпт: `ConsultationPrompts.security_consultation()`

**Консультации по продажам:**
- Ключевые слова: `["продаж", "цена", "стоимость", "тариф", "подключ", "установк", "купить", "приобрести", "оформить", "заказать", "продукт", "решение"]`
- Действие: Поиск в базе знаний через `Pass24Functions.get_sales_info()`
- Промпт: `ConsultationPrompts.sales_consultation()` с контекстом из базы знаний

**Консультации по техподдержке:**
- Ключевые слова: `["как использовать", "как работает", "инструкция", "помощь", "поддержка", "вопрос", "проблема", "не работает", "ошибка"]`
- Действие: Поиск в базе знаний через `Pass24Functions.get_support_info()`
- Промпт: `ConsultationPrompts.support_consultation()` с контекстом из базы знаний

**Общие консультации:**
- Если не подходит ни один из вышеперечисленных типов
- Промпт: прямой вызов `concierge.consult(text)` без специального промпта

### 4.3 Формирование промпта

#### Пример 1: Консультация по функции PASS24

```python
# 1. Определение типа запроса
query = "как работает пропуск?"
# → тип: "pass24_function", функция: "пропуска"

# 2. Поиск информации о функции
function_info = Pass24Functions.get_function_info("пропуска")
# → возвращает описание из словаря FUNCTIONS

# 3. Формирование промпта
prompt = ConsultationPrompts.pass24_function_explanation("пропуска")
# → промпт: "Пользователь хочет понять функцию приложения PASS24: 'пропуска'.
#            Объясни логику и смысл этой функции..."

# 4. Запрос к Claude
response = concierge.consult(prompt)
```

#### Пример 2: Консультация по продажам с базой знаний

```python
# 1. Определение типа запроса
query = "сколько стоит подключение?"
# → тип: "sales_consultation"

# 2. Поиск в базе знаний
sales_info = Pass24Functions.get_sales_info("подключение")
# → поиск в sales_data.json по ключевым словам
# → возвращает релевантный контент из базы знаний или None

# 3. Формирование промпта с контекстом
prompt = ConsultationPrompts.sales_consultation(query, sales_info)
# → промпт: "Пользователь спрашивает о продажах или продуктах PASS24: 'сколько стоит подключение?'.
#            Дополнительная информация из базы знаний: [контент из sales_info]..."

# 4. Запрос к Claude
response = concierge.consult(prompt)
```

#### Пример 3: Общая консультация

```python
# 1. Определение типа запроса
query = "как подготовить дом к зиме?"
# → тип: "general_consultation" (не подходит под другие категории)

# 2. Прямой запрос к Claude без специального промпта
response = concierge.consult(query)
# → Claude использует системный промпт и сам определяет, что это консультация по дому
```

### 4.4 Обработка ответа от Claude

После получения ответа от Claude:

1. **Проверка возможности ответить:**
   ```python
   if self._cannot_answer_question(response, text):
       await self._forward_to_support(update, context, text)
       return
   ```
   
   Метод `_cannot_answer_question()` ищет индикаторы:
   - "не могу помочь"
   - "не знаю"
   - "обратитесь в поддержку"
   - и другие фразы, указывающие на невозможность ответить

2. **Если бот может ответить:**
   - Отправка ответа пользователю через `update.message.reply_text(response)`

3. **Если бот не может ответить:**
   - Переадресация в поддержку через `_forward_to_support()`
   - Сообщение пользователю о переадресации

---

## 5. Специальные сценарии

### 5.1 AI-аудит безопасности

**Инициализация:**
- Команда `/audit` → `audit_command()`
- Выбор типа объекта (посёлок/дом/квартира) → `audit_type_handler()`
- Создание экземпляра `SecurityAudit` → сохранение в `active_audits[user_id]`

**Процесс:**
1. `SecurityAudit.start_audit(audit_type)` — генерация вопросов
2. Пошаговый опрос через `ConversationHandler` (по одному вопросу)
3. Сохранение ответов через `SecurityAudit.submit_answer()`
4. После всех вопросов → `SecurityAudit._generate_results()`
5. Формирование промпта с контекстом всех ответов
6. Запрос к Claude для анализа и оценки
7. Отображение результатов пользователю

**Вопросы:**
- Хранятся статически в `SecurityAudit._generate_questions()`
- Разные наборы для посёлка, дома и квартиры
- Каждый вопрос имеет уникальный ID

### 5.2 Обработка голосовых сообщений

**Процесс:**
1. Получение голосового файла через Telegram Bot API
2. Сохранение во временный файл (`.ogg`)
3. Распознавание речи через Whisper в отдельном потоке (не блокирует event loop)
4. Извлечение текста из результата
5. Удаление временного файла
6. Обработка как текстовое сообщение

**Модель Whisper:**
- По умолчанию: `tiny` (самая быстрая, ~39MB)
- Настраивается через `WHISPER_MODEL` в `.env`
- Поддерживает русский язык

### 5.3 История сообщений

**Хранение:**
- `self.user_message_history[user_id]` — deque с последними 10 сообщениями
- Формат: `{"text": str, "message_id": int}`

**Использование:**
- Сохраняется при каждом сообщении через `_save_message_to_history()`
- Может быть использована для контекста в будущих версиях

---

## 6. Конфигурация и переменные окружения

### 6.1 Обязательные переменные

- `ANTHROPIC_API_KEY` — API ключ для Claude API
- `TELEGRAM_BOT_TOKEN` — токен Telegram бота

### 6.2 Опциональные переменные

- `CLAUDE_MODEL` — модель Claude (по умолчанию: `claude-3-haiku-20240307`)
- `WHISPER_MODEL` — модель Whisper (по умолчанию: `tiny`)
- `GITHUB_TOKEN` — токен GitHub для доступа к приватным репозиториям (опционально)
- `SUPPORT_BOT_USERNAME` — username бота поддержки (по умолчанию: `A24pass24helpBot`)
- `SUPPORT_CHAT_ID` — ID чата для переадресации сообщений (опционально)

---

## 7. Логирование и мониторинг

### 7.1 Логирование

- Используется стандартный модуль `logging` Python
- Уровень: `INFO`
- Формат: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`

### 7.2 Логи обновления базы знаний

- Файл: `data/knowledge_base/update_log.json`
- Содержит последние 100 записей обновлений
- Формат записи:
  ```json
  {
    "timestamp": "2024-01-01T08:00:00",
    "sales": {
      "updated": true,
      "files_count": 15,
      "new_files": ["новый_файл.md"]
    },
    "support": {
      "updated": true,
      "files_count": 20,
      "new_files": []
    },
    "errors": []
  }
  ```

---

## 8. Обработка ошибок

### 8.1 Ошибки инициализации

- Если отсутствует `ANTHROPIC_API_KEY` → `ValueError` при создании `Pass24Concierge`
- Если отсутствует `TELEGRAM_BOT_TOKEN` → `ValueError` при создании `TelegramBot`
- Если не удалось загрузить Whisper → бот работает без распознавания речи

### 8.2 Ошибки обработки запросов

- Ошибки при обработке запроса логируются через `logger.error()`
- При ошибке запрос переадресовывается в поддержку через `_forward_to_support()`

### 8.3 Ошибки обновления базы знаний

- Ошибки логируются в `update_log.json` в поле `errors`
- Бот продолжает работать с кэшированными данными

---

## 9. Расширение функциональности

### 9.1 Добавление новой функции PASS24

1. Добавить описание в словарь `Pass24Functions.FUNCTIONS` в `bot/pass24_info.py`
2. При необходимости добавить синонимы в словарь `synonyms` в методе `get_function_info()`

### 9.2 Добавление нового типа консультации

1. Добавить метод в `ConsultationPrompts` для формирования промпта
2. Добавить логику определения типа запроса в `TelegramBot._process_query()`
3. Добавить маршрутизацию к новому обработчику

### 9.3 Изменение системного промпта

1. Отредактировать атрибут `self.system_prompt` в `Pass24Concierge.__init__()`
2. Изменения повлияют на все ответы бота

### 9.4 Добавление вопросов в аудит

1. Отредактировать метод `SecurityAudit._generate_questions()`
2. Добавить вопросы в соответствующий список (`посёлок`, `дом`, `квартира`)

---

## 10. Примеры использования методов

### 10.1 Получение информации о функции

```python
from bot.pass24_info import Pass24Functions

# Поиск функции
info = Pass24Functions.get_function_info("пропуск")
if info:
    print(info)
```

### 10.2 Поиск в базе знаний

```python
from bot.pass24_info import Pass24Functions

# Поиск информации о продажах
sales_info = Pass24Functions.get_sales_info("тариф")
if sales_info:
    print(sales_info)

# Поиск информации техподдержки
support_info = Pass24Functions.get_support_info("домофон")
if support_info:
    print(support_info)
```

### 10.3 Формирование промпта

```python
from bot.prompts import ConsultationPrompts

# Промпт для консультации по безопасности
prompt = ConsultationPrompts.security_consultation("как защитить дом?")
print(prompt)

# Промпт для консультации по продажам с контекстом
context = "Тариф базовый: 1000 руб/мес"
prompt = ConsultationPrompts.sales_consultation("сколько стоит?", context)
print(prompt)
```

### 10.4 Запрос к Claude API

```python
from bot.concierge import Pass24Concierge

concierge = Pass24Concierge()
response = concierge.consult("Как подготовить дом к зиме?")
print(response)
```

---

## 11. Заключение

Данный документ описывает внутреннюю работу бота PASS24 AI Консьерж. При внесении изменений в архитектуру или функциональность бота рекомендуется обновлять этот документ для актуальности информации.

**Ключевые моменты:**
- Все ответы генерируются через Claude API на основе системного промпта
- База знаний обновляется автоматически из GitHub репозитория
- Тип запроса определяется по ключевым словам
- Релевантная информация из базы знаний добавляется в промпт перед запросом к Claude
- Бот переадресовывает запросы в поддержку, если не может ответить

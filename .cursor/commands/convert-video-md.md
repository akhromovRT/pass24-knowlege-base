# Конвертация видео в Markdown

Конвертирует видео файлы в Markdown документы с автоматическим распознаванием речи, фиксацией ключевых моментов и извлечением скриншотов.

## Когда использовать

- Для создания текстовых версий видео инструкций
- Для автоматической транскрипции видео с голосовым сопровождением
- Для подготовки документации на основе видео материалов

## Требования

Перед использованием необходимо установить зависимости:

```bash
pip install openai-whisper
```

Рекомендуется также установить `ffmpeg` для более быстрой обработки:

```bash
# macOS
brew install ffmpeg

# Linux
sudo apt-get install ffmpeg

# Windows
# Скачать с https://ffmpeg.org/download.html
```

## Структура директорий и работа с .gitignore

**Важно:** Вся работа команды происходит **только в одной директории** — той, где находятся обрабатываемые видеофайлы (рабочая директория). Никакие файлы не создаются и не сохраняются вне этой папки.

### Организация файлов

1. **Рабочая директория** — папка с исходными видео (например, `Видео Инструкции Приложения/`). Команда запускается для этой папки; все результаты остаются только в ней.
2. **В рабочей директории создаётся:**

   - **MD файлы** — рядом с видео, в той же папке
   - **Папка `screenshots/`** — вложенная в рабочую директорию; в неё складываются извлечённые скриншоты
   - **Переименованные видео** (`-converted`) — остаются в той же папке
3. **В .gitignore** добавляют только видеофайлы (`.mp4`, `-converted.mp4`), **не** всю папку: MD и `screenshots/` должны попадать в репозиторий.

### Пример структуры после обработки

```
База знаний/.../Видео Инструкции Приложения/   # ← Рабочая директория (всё только здесь)
├── 1. Пропуск для пешехода.mp4                # ← Исходный (в .gitignore)
├── 1. Пропуск для пешехода-converted.mp4      # ← Переименованный (в .gitignore)
├── 1. Пропуск для пешехода.md                 # ← MD результат
├── 2. Пропуск на автомобиль.md
├── screenshots/                                # ← Вложенная папка со скриншотами
│   ├── 1._Пропуск_для_пешехода_screenshot_01.png
│   └── ...
└── ...
```

### Настройка .gitignore

Игнорировать только видео, **не** рабочую папку целиком:

```gitignore
# Только видеофайлы
**/*.mp4
**/*-converted.mp4
```

**Примечание:** MD файлы и папка `screenshots/` лежат в рабочей директории и **не** должны быть в `.gitignore` — они относятся к результатам обработки и попадают в репозиторий.

---

## Инструкции

### Шаг 1: Определить файлы для конвертации

Пользователь может указать:

- Один файл: путь к видео файлу
- Несколько файлов: список путей через пробел
- Относительные или абсолютные пути

**Рабочая директория:** Результаты (MD, `screenshots/`, переименованные видео) создаются **только в папке, где лежит каждый видеофайл**. Ничего не сохраняется в другие директории. Рекомендуется обрабатывать видео из одной папки — тогда все результаты будут в ней.

Примеры:

- `База знаний/Тех. поддержка/Инструкции PASS24.online/Видео Инструкции WEB (Новые)/Модуль _Доверенности_ (1).mp4`
- Несколько файлов из той же папки

### Шаг 2: Проверить наличие скрипта

```bash
# Проверить существование скрипта
test -f scripts/convert_video_to_md.py && echo "Скрипт найден" || echo "Скрипт не найден"
```

Если скрипт не найден, сообщить пользователю и предложить создать его.

### Шаг 3: Проверить зависимости

```bash
# Проверить наличие whisper
python3 -c "import whisper" 2>/dev/null && echo "Whisper установлен" || echo "Whisper не установлен"
```

Если whisper не установлен, предложить установить:

```bash
pip install openai-whisper
```

### Шаг 4: Запустить конвертацию

Для каждого указанного файла:

```bash
python3 scripts/convert_video_to_md.py "<путь_к_файлу>"
```

Или для нескольких файлов:

```bash
python3 scripts/convert_video_to_md.py "<файл1>" "<файл2>" "<файл3>"
```

**Важно: Процесс транскрибации автоматически фиксирует основные моменты и извлекает скриншоты**

Во время работы скрипта происходит:

1. **Распознавание речи** — Whisper анализирует видео и распознает речь
2. **Фиксация ключевых моментов** — автоматически определяются ключевые моменты на основе сегментов распознанной речи
3. **Извлечение скриншотов** — автоматически извлекаются скриншоты из ключевых моментов видео (до 15 скриншотов на видео)
4. **Сохранение скриншотов** — скриншоты сохраняются во вложенной папке `screenshots/` рабочей директории
5. **Вставка скриншотов в MD** — ссылки на скриншоты автоматически вставляются в MD файл рядом с соответствующими сегментами текста (путь: `screenshots/...`)

**Требования для извлечения скриншотов:**

- Должен быть установлен `ffmpeg` (проверяется автоматически)
- Если `ffmpeg` не установлен, скриншоты не будут извлечены, но конвертация продолжится

**Что происходит с скриншотами:**

- Скриншоты извлекаются из начала ключевых сегментов распознанной речи
- Автоматически выбираются равномерно распределенные моменты видео
- Скриншоты вставляются в MD файл рядом с соответствующими временными метками
- Все скриншоты сохраняются в папке `screenshots/` (вложена в рабочую директорию) для последующего использования

### Шаг 5: Проверить результаты

После обработки каждого файла должны быть созданы:

1. **MD файл** с тем же именем, что и исходный файл, но с расширением `.md`

   - Создаётся **в рабочей директории** (папка с видео)
   - Содержит распознанный текст, структурированные сегменты и ссылки на скриншоты
2. **Исходное видео** переименовано с добавлением `-converted` перед расширением

   - Остаётся **в рабочей директории** (папка с видео)
   - Видеофайлы добавляют в `.gitignore`
3. **Папка `screenshots/`** с извлечёнными скриншотами (если установлен ffmpeg)

   - Создаётся **вложенной в рабочую директорию**
   - Содержит все извлечённые скриншоты из ключевых моментов видео
4. **Скриншоты встроены в MD файл** рядом с соответствующими сегментами текста

   - Ссылки на скриншоты используют относительные пути: `screenshots/...` (относительно MD файла)

**Пример структуры:**

```
База знаний/.../Видео Инструкции Приложения/   # ← Рабочая директория (всё только здесь)
├── 1. Пропуск для пешехода.mp4                # ← Исходный (в .gitignore)
├── 1. Пропуск для пешехода-converted.mp4      # ← Переименованный (в .gitignore)
├── 1. Пропуск для пешехода.md                 # ← MD файл
├── screenshots/                                # ← Вложенная папка со скриншотами
│   ├── 1._Пропуск_для_пешехода_screenshot_01.png
│   └── ...
└── ...
```

**Важно:**

- В `.gitignore` только видео (`.mp4`, `-converted.mp4`), не вся папка
- MD файлы и папка `screenshots/` создаются в рабочей директории и **должны попадать в репозиторий**

### Шаг 6: Проверить содержимое MD файла

Открыть созданный MD файл и проверить:

- Наличие распознанного текста
- Корректность форматирования
- Корректность ссылок на скриншоты (путь `screenshots/...`)
- При необходимости отредактировать или дополнить

**Проверка скриншотов:**

- Убедиться, что вложенная папка `screenshots/` в рабочей директории создана и содержит файлы
- Проверить, что скриншоты отображаются в MD файле (путь: `screenshots/...`)
- При необходимости добавить дополнительные скриншоты вручную (см. Шаг 7.3)

### Шаг 7: Редактирование и улучшение созданных MD файлов (выполняется автоматически)

**Выполняется сразу после Шагов 4–6, без запроса пользователю.** Для каждого созданного MD файла агент обязан подготовить полный документ по стандартам базы знаний, выполнив все подшаги 7.1–7.4. Последовательность и чек-лист — в `agent_docs/convert-video-step7.md`.

#### 7.1: Исправление ошибок распознавания речи

Для каждого созданного MD файла:

1. **Открыть MD файл** и исходное видео (с суффиксом `-converted.mp4`)
2. **Просмотреть видео** и сравнить с распознанным текстом
3. **Исправить типичные ошибки распознавания:**

   - Неправильно распознанные термины (например: "PAST24" → "PASS24", "моторм" → "модуле")
   - Опечатки в названиях интерфейса ("боковой меню" → "боковое меню", "прав верхнем углу" → "правом верхнем углу")
   - Неправильно распознанные числа и даты
   - Искаженные технические термины
   - Пропущенные слова или фразы
4. **Проверить грамматику и пунктуацию:**

   - Исправить грамматические ошибки
   - Добавить недостающие знаки препинания
   - Разбить длинные предложения на более короткие
5. **Проверить терминологию:**

   - Убедиться, что все термины соответствуют принятой в компании терминологии
   - Проверить названия модулей, кнопок, разделов интерфейса

#### 7.2: Добавление структуры и форматирования

Привести MD файл к структуре согласно шаблону базы знаний (`agent_docs/Шаблон статьи базы знаний.md`):

1. **Добавить метаданные документа:**

   ```markdown
   ## Метаданные документа

   | Параметр | Значение |
   |----------|----------|
   | **Версия** | 1.0 |
   | **Дата создания** | [текущая дата] |
   | **Дата последнего обновления** | [текущая дата] |
   | **Автор** | [ФИО, должность] |
   | **Тип документа** | Обучение |
   | **Отдел** | Тех. поддержка |
   ```
2. **Добавить раздел "Целевая аудитория":**

   ```markdown
   ## Целевая аудитория

   **Для кого:** Специалисты техподдержки, новые сотрудники
   **Уровень подготовки:** Начинающий
   **Когда использовать:** При обучении работе с модулями системы PASS24.online
   ```
3. **Добавить "Краткое описание":**

   - 2-3 предложения о назначении документа
   - Что читатель узнает из документа
4. **Структурировать основной контент:**

   - Разбить текст на логические разделы с заголовками H2, H3
   - Преобразовать описание действий в пошаговые инструкции
   - Использовать списки для перечислений
   - Выделить важную информацию жирным шрифтом
5. **Создать раздел "Пошаговая инструкция":**

   - Каждый шаг должен содержать:
     - **Что делать:** список действий
     - **Где:** в какой системе/интерфейсе
     - **Результат:** что должно получиться
     - **Скриншот:** ссылка на скриншот (добавить на следующем шаге)
6. **Добавить раздел "Контрольный чек-лист"** (для процедур):

   - Список пунктов для проверки выполнения
7. **Добавить раздел "История изменений":**

   ```markdown
   ## История изменений

   | Версия | Дата | Автор | Изменения |
   |--------|------|-------|-----------|
   | 1.0 | [дата] | [автор] | Первоначальная версия на основе видео |
   ```

#### 7.3: Дополнение инструкциями и скриншотами из видео

**Важно:** Скриншоты уже автоматически извлечены во время транскрибации (Шаг 4) и встроены в MD файл. Этот шаг нужен только для добавления дополнительных скриншотов, если требуется.

1. **Проверить автоматически извлеченные скриншоты:**

   - Открыть папку `screenshots/` рядом с MD файлом
   - Проверить, что скриншоты присутствуют в MD файле в разделе "Сегменты с временными метками"
   - Убедиться, что скриншоты соответствуют ключевым моментам
2. **При необходимости добавить дополнительные скриншоты:**

   - Просмотреть видео и определить дополнительные ключевые моменты:
     - Интерфейсы системы
     - Кнопки и элементы управления
     - Результаты действий
     - Важные предупреждения или сообщения
3. **Создать дополнительные скриншоты из видео:**

   - Использовать инструменты для извлечения кадров из видео (например, `ffmpeg`)
   - Или сделать скриншоты вручную при просмотре видео
   - Сохранить скриншоты в папке `screenshots/`
4. **Добавить дополнительные скриншоты в MD файл:**

   ```markdown
   ![Описание скриншота](screenshots/название-файла.png)
   ```

   - Разместить скриншоты рядом с соответствующими шагами инструкции
   - Добавить подписи к скриншотам
   - Скриншоты должны находиться во вложенной папке `screenshots/` рабочей директории
5. **Дополнить инструкции деталями:**

   - Добавить информацию о возможных вариантах действий
   - Указать альтернативные способы выполнения задач
   - Добавить предупреждения о типичных ошибках
   - Включить информацию о том, что делать при проблемах
6. **Добавить раздел "Типичные ошибки и их решение"** (если применимо):

   ```markdown
   ## Типичные ошибки и их решение

   | Ошибка | Причина | Решение |
   |--------|---------|---------|
   | [Описание] | [Причина] | [Решение] |
   ```
7. **Добавить раздел "FAQ"** (если есть часто задаваемые вопросы):

   - Ответы на типовые вопросы по модулю
8. **Добавить раздел "Связанные материалы":**

   - Ссылки на другие инструкции по системе
   - Связанные модули и документы

#### 7.4: Финальная проверка

После редактирования каждого MD файла проверить:

- [ ] Все ошибки распознавания исправлены
- [ ] Текст структурирован согласно шаблону
- [ ] Добавлены метаданные документа
- [ ] Указана целевая аудитория
- [ ] Есть краткое описание
- [ ] Основной контент разбит на логические разделы
- [ ] Создана пошаговая инструкция (если применимо)
- [ ] Проверены автоматически извлеченные скриншоты
- [ ] При необходимости добавлены дополнительные скриншоты
- [ ] Скриншоты размещены рядом с соответствующими шагами
- [ ] Добавлены контрольные чек-листы (если применимо)
- [ ] Добавлена история изменений
- [ ] Проверена грамматика и пунктуация
- [ ] Проверена терминология
- [ ] Документ соответствует стандартам базы знаний

#### 7.5: Пример структуры готового документа

После обработки документ должен иметь следующую структуру:

```markdown
# Модуль [Название]

## Метаданные документа
[таблица с метаданными]

## Целевая аудитория
[описание аудитории]

## Краткое описание
[2-3 предложения]

## Пошаговая инструкция

### Шаг 1: [Название действия]
**Что делать:**
1. [Действие 1]
2. [Действие 2]

**Где:** [В какой системе/интерфейсе]

**Результат:** [Что должно получиться]

![Скриншот шага 1](screenshots/step1.png)

### Шаг 2: [Название действия]
[Аналогично шагу 1]

## Контрольный чек-лист
- [ ] [Пункт 1]
- [ ] [Пункт 2]

## Типичные ошибки и их решение
[Таблица с ошибками]

## История изменений
[Таблица с версиями]
```

#### 7.6: Инструменты для работы со скриншотами

Для извлечения кадров из видео можно использовать:

```bash
# Извлечь кадр на определенной секунде (например, 10 секунда)
ffmpeg -i "видео-converted.mp4" -ss 00:00:10 -vframes 1 screenshot.png

# Извлечь несколько кадров с интервалом
ffmpeg -i "видео-converted.mp4" -vf "fps=1/10" screenshots/frame_%03d.png
```

Или использовать видеоплеер с функцией создания скриншотов.

## Параметры модели

По умолчанию используется модель `base`. Можно указать другую модель:

- `tiny` - самая быстрая, наименьшая точность
- `base` - баланс скорости и точности (по умолчанию)
- `small` - лучше точность, медленнее
- `medium` - высокая точность, медленно
- `large` - максимальная точность, очень медленно

Пример с другой моделью:

```bash
python3 scripts/convert_video_to_md.py --model small "<путь_к_файлу>"
```

## Обработка ошибок

Если конвертация не удалась:

1. Проверить, что файл существует и доступен
2. Проверить формат видео (поддерживаются: mp4, avi, mov, mkv, webm, flv, m4v)
3. Проверить наличие свободного места на диске
4. Проверить, что видео содержит аудиодорожку
5. При проблемах с распознаванием попробовать другую модель (например, `small` или `medium`)

### Ошибки соединения / сети (и почему они бывают при устойчивом интернете)

Скрипт автоматически **повторяет попытки** при сетевых ошибках (до 5 раз с растущей паузой: 5, 15, 30, 60, 120 с) и увеличивает таймаут сокетов при загрузке модели. Если ошибки всё равно появляются:

**Откуда берутся «ошибки соединения» при стабильном интернете:**

1. **Загрузка модели Whisper**Модели качаются с `openaipublic.azureedge.net` (Azure CDN). В `openai-whisper` загрузка идёт через `urllib.request.urlopen` **без своего таймаута** — используется только системный socket timeout. При большом файле (base ~140 MB, large — больше) и кратких просадках или лагах соединение может обрываться, и одна попытка без retry даёт ошибку.**Что сделано в скрипте:** увеличен `socket.setdefaulttimeout` до 600 с на время загрузки и вызова `transcribe`, плюс retry при сетевых исключениях.
2. **Tiktoken (словарь для токенизатора)**При первом `model.transcribe(...)` может подгружаться словарь с `openaipublic.blob.core.windows.net`. Краткий обрыв или таймаут даёт `ConnectionError` / `Max retries exceeded` и т.п.**Что сделано:** вызов `transcribe` обёрнут в ту же retry-логику.
3. **Краткие обрывы и нестабильность**Даже при «устойчивом» интернете возможны краткие потери пакетов, переключение Wi‑Fi/соты, срабатывание фаервола или антивируса на долгие сессии. Одна попытка часто падает; несколько попыток с паузами обычно проходят.
4. **Рекомендации при частых ошибках**

   - Скачать модель один раз при хорошей сети: запустить скрипт с коротким тестовым видео; модель сохранится в `~/.cache/whisper/` (или `$XDG_CACHE_HOME/whisper`). Дальнейшие запуски при уже скачанной модели не ходят в сеть за моделью.
   - Проверить прокси, VPN, корпоративный фаервол: они могут обрывать длительные HTTPS-сессии к Azure.
   - При стабильных сбоях — попробовать модель `tiny` (меньший файл, быстрее качается).

Если скриншоты не извлекаются:

1. Проверить, что установлен `ffmpeg` (команда: `which ffmpeg`)
2. Если `ffmpeg` не установлен, конвертация продолжится, но скриншоты не будут извлечены
3. Установить `ffmpeg`:
   ```bash
   # macOS
   brew install ffmpeg

   # Linux
   sudo apt-get install ffmpeg
   ```
4. После установки `ffmpeg` запустить конвертацию заново
5. Если скриншоты не извлекаются даже с установленным `ffmpeg`, проверить права доступа к папке и наличие свободного места

## Пример использования

```bash
# Один файл
python3 scripts/convert_video_to_md.py "База знаний/Тех. поддержка/Инструкции PASS24.online/Видео Инструкции WEB (Новые)/Модуль _Доверенности_ (1).mp4"

# Несколько файлов
python3 scripts/convert_video_to_md.py \
  "База знаний/Тех. поддержка/Инструкции PASS24.online/Видео Инструкции WEB (Новые)/Модуль _Доверенности_ (1).mp4" \
  "База знаний/Тех. поддержка/Инструкции PASS24.online/Видео Инструкции WEB (Новые)/Модуль Адреса.mp4"

# С другой моделью
python3 scripts/convert_video_to_md.py --model small "<путь_к_файлу>"
```

## Примечания

- Первый запуск может занять время из-за загрузки модели Whisper
- **Сетевые ошибки:** при загрузке модели и при первом `transcribe` скрипт сам повторяет попытки (retry) и увеличивает таймаут; подробнее — в разделе «Обработка ошибок → Ошибки соединения / сети»
- Время обработки зависит от длины видео и выбранной модели
- Для длинных видео рекомендуется использовать модель `base` или `small`
- Распознавание работает лучше с четкой речью без фонового шума
- **Скриншоты автоматически извлекаются во время транскрибации** из ключевых моментов видео
- Количество скриншотов ограничено до 15 на видео для оптимальной производительности
- Скриншоты выбираются автоматически из равномерно распределенных сегментов распознанной речи
- Если `ffmpeg` не установлен, конвертация продолжится, но скриншоты не будут извлечены

## Важно: Шаг 7 выполняется автоматически

**Сразу после конвертации (Шаги 4–6)** для каждого созданного MD агент выполняет **Шаг 7 (7.1–7.4)** без запроса пользователю. Итоговый документ готовится со всеми шагами: метаданные, целевая аудитория, краткое описание, правки распознавания, структура по шаблону, при необходимости — дополнительные скриншоты и чек-листы, история изменений, финальная проверка.

**Последовательность и чек-лист Шага 7:** `agent_docs/convert-video-step7.md`.

**После выполнения Шага 7:**

- Проверить настройку `.gitignore`: только `*.mp4` и `*-converted.mp4`, **не** вся рабочая папка; MD и `screenshots/` — в репозиторий.
- Обновить README раздела при необходимости.
